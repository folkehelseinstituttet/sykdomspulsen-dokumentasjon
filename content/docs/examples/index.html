---
date: 2019-02-11
draft: false
summary: Examples.
title: Examples
weight: 4
editor_options: 
  chunk_output_type: console
---



<div id="weather" class="section level2">
<h2>Weather</h2>
<p>We will now work our way through an example implementation of a weather surveillance system.</p>
<div id="database-tableschema" class="section level3">
<h3>Database table/schema</h3>
<p>To begin with, we need to create a database table <code>schema</code> that describes the final database table that we will store the information that we will collect.</p>
<pre class="r"><code>sc::add_schema(
  name = &quot;example_weather&quot;,
  schema = sc::Schema$new(
    db_config = sc::config$db_config,
    db_table = &quot;example_weather&quot;,
    db_field_types =  c(
      &quot;granularity_time&quot; = &quot;TEXT&quot;,
      &quot;granularity_geo&quot; = &quot;TEXT&quot;,
      &quot;location_code&quot; = &quot;TEXT&quot;,
      &quot;border&quot; = &quot;INTEGER&quot;,
      &quot;age&quot; = &quot;TEXT&quot;,
      &quot;sex&quot; = &quot;TEXT&quot;,
      &quot;year&quot; = &quot;INTEGER&quot;,
      &quot;week&quot; = &quot;INTEGER&quot;,
      &quot;yrwk&quot; = &quot;TEXT&quot;,
      &quot;season&quot; = &quot;TEXT&quot;,
      &quot;x&quot; = &quot;DOUBLE&quot;,
      &quot;date&quot; = &quot;DATE&quot;,

      &quot;tg&quot; = &quot;DOUBLE&quot;,
      &quot;tx&quot; = &quot;DOUBLE&quot;,
      &quot;tn&quot; = &quot;DOUBLE&quot;,
      &quot;rr&quot; = &quot;DOUBLE&quot;
    ),
    db_load_folder = tempdir(),
    keys =  c(
      &quot;location_code&quot;,
      &quot;date&quot;
    ),
    validator_field_types = sc::validator_field_types_sykdomspulsen,
    validator_field_contents = sc::validator_field_contents_sykdomspulsen
  )
)</code></pre>
<p>This <code>schema</code> has a few main parts.</p>
<p><code>name</code> is an internal reference that we will use to access this database table at <code>sc::config$schemas$example_weather</code>.</p>
<p><code>db_config</code> is a list that contains information about the database:</p>
<pre class="r"><code>names(sc::config$db_config)
## [1] &quot;driver&quot;             &quot;server&quot;             &quot;port&quot;              
## [4] &quot;user&quot;               &quot;password&quot;           &quot;db&quot;                
## [7] &quot;trusted_connection&quot;</code></pre>
<p><code>db_table</code> is the name of the database table in the database.</p>
<p><code>db_field_types</code> is a vector containing the names and variable types of the columns of the database table.</p>
<p><code>keys</code> are the columns that will form the primary key of the databse (i.e. identify unique rows).</p>
<p><code>validator_field_types</code> is a validator that is useful for ensuring that your database table names are consistent with predetermined rules. For example, in Sykdomspulsen we have decided that we always want the first 12 columns to be <code>granularity_time</code>, <code>granularity_geo</code>, <code>location_code</code>, <code>border</code>, <code>age</code>, <code>sex</code>, <code>year</code>, <code>week</code>, <code>yrwk</code>, <code>season</code>, <code>x</code>, <code>date</code>. However, while developing new code we found that it was difficult to force all developers to remember to include these 12 columns in the correct order. The validator <code>sc::validator_field_types_sykdomspulsen</code> ensures that the first 12 columns are as expected, and otherwise the developer will not be able to run their code.</p>
<p><code>validator_field_contents</code> is a validator that ensures that the contents of your data is correct. We experienced that there were issues with <code>granularity_time</code> sometimes containing the value <code>week</code> and sometimes containing the value <code>weekly</code>. To maintain consistency in our data, the validator <code>sc::validator_field_contents_sykdomspulsen</code> will throw an error if it observes non-accepted values for certain variables.</p>
</div>
<div id="task" class="section level3">
<h3>Task</h3>
<p>We now need to create a task that will download the data from an API, clean it, and store it in the database schema.</p>
<p>For simple tasks we can use the convenience function <code>sc::task_from_config</code>.</p>
<pre class="r"><code>sc::add_task(
  sc::task_from_config(
    name = &quot;example_weather&quot;,
    type = &quot;data&quot;,
    action = &quot;example_weather&quot;,
    schema = list(output = sc::config$schemas$example_weather)
  )
)</code></pre>
<p><code>name</code> is an internal name that we will use to reference the task.</p>
<p><code>type</code> is one of <code>data</code>, <code>analysis</code>, <code>ui</code>, or <code>single</code>.</p>
<p><code>action</code> is the function that will be called.</p>
<p><code>schema</code> is a list containing <code>schema</code>s.</p>
</div>
<div id="action" class="section level3">
<h3>Action</h3>
<p>We now need to develop the action <code>example_weather</code>. We do this by creating an R function that contains 3 arguments:</p>
<pre class="r"><code>datar_weather &lt;- function(data, argset, schema) {
  # sc::tm_run_task(&quot;example_weather&quot;)

  if(plnr::is_run_directly()){
    data &lt;- sc::tm_get_data(&quot;example_weather&quot;)
    argset &lt;- sc::tm_get_argset(&quot;example_weather&quot;)
    schema &lt;- sc::tm_get_schema(&quot;example_weather&quot;)
  }
  
  # download the forecast for Oslo
  a &lt;- httr::GET(glue::glue(&quot;https://api.met.no/weatherapi/locationforecastlts/1.3/?lat=59.9&amp;lon=10.8&quot;), httr::content_type_xml())
  a &lt;- xml2::read_xml(a$content)

  baz &lt;- xml2::xml_find_all(a, &quot;.//maxTemperature&quot;)
  res &lt;- vector(&quot;list&quot;, length = length(baz))
  for (i in seq_along(baz)) {
    parent &lt;- xml2::xml_parent(baz[[i]])
    grandparent &lt;- xml2::xml_parent(parent)
    time_from &lt;- xml2::xml_attr(grandparent, &quot;from&quot;)
    time_to &lt;- xml2::xml_attr(grandparent, &quot;to&quot;)
    x &lt;- xml2::xml_find_all(parent, &quot;.//minTemperature&quot;)
    temp_min &lt;- xml2::xml_attr(x, &quot;value&quot;)
    x &lt;- xml2::xml_find_all(parent, &quot;.//maxTemperature&quot;)
    temp_max &lt;- xml2::xml_attr(x, &quot;value&quot;)
    x &lt;- xml2::xml_find_all(parent, &quot;.//precipitation&quot;)
    precip &lt;- xml2::xml_attr(x, &quot;value&quot;)

    res[[i]] &lt;- data.frame(
      time_from = as.character(time_from),
      time_to = as.character(time_to),
      tx = as.numeric(temp_max),
      tn = as.numeric(temp_min),
      rr = as.numeric(precip)
    )
  }
  res &lt;- rbindlist(res)
  res &lt;- res[stringr::str_sub(time_from, 12, 13) %in% c(&quot;00&quot;, &quot;06&quot;, &quot;12&quot;, &quot;18&quot;)]
  res[, date := as.Date(stringr::str_sub(time_from, 1, 10))]
  res[, N := .N, by = date]
  res &lt;- res[N == 4]
  res &lt;- res[, .(
    tg = NA,
    tx = max(tx),
    tn = min(tn),
    rr = sum(rr)
  ),
  keyby = .(date)
  ]
  
  # we look at the downloaded data
  print(res)
  
  # we now need to format it
  res[, granularity_time := &quot;day&quot;]
  res[, granularity_geo := &quot;county&quot;]
  res[, location_code := &quot;county03&quot;]
  res[, border := 2020]
  res[, age := &quot;total&quot;]
  res[, sex := &quot;total&quot;]
  res[, year := fhi::isoyear_n(date)]
  res[, week := fhi::isoweek_n(date)]
  res[, yrwk := fhi::isoyearweek(date)]
  res[, season := fhi::season(yrwk)]
  res[, x := fhi::x(week)]
  
  # upload it to the database
  schema$output$db_upsert_load_data_infile(res)
}</code></pre>
<p>It is important to pay attention to the lines at the top of the function:</p>
<pre><code>if(plnr::is_run_directly()){
  data &lt;- sc::tm_get_data(&quot;example_weather&quot;)
  argset &lt;- sc::tm_get_argset(&quot;example_weather&quot;)
  schema &lt;- sc::tm_get_schema(&quot;example_weather&quot;)
}</code></pre>
<p>These lines allow a person to run the code interactively from directly inside the function, without running any prior “setup” code. This means that if a person wants to develop or debug a particular task, they can work directly inside that task, without “going to file X, running lines A, B, C, going to file Y, running lines D, E, F, …”. Instead, they can treat the task function like an independent R script.</p>
<p>This has large benefits, as it means that:</p>
<ul>
<li>more advanced R programmers can work with the broader “infrastructure” (setting up database schema, tasks)</li>
<li>less-advanced R programmers can work within a task that has already been set up (e.g. modifying it as if it were a simple independent R script)</li>
</ul>
<p>This means that resources can be used most effectively, with advanced programmers working on the difficult tasks, with less-advanced programmers assisting in areas where they can (without the need for them to understand the more complicated aspects)</p>
</div>
<div id="running-the-task" class="section level3">
<h3>Running the task</h3>
<p>The following command is used to run the task from within R:</p>
<pre><code>sc::tm_run_task(&quot;example_data&quot;)</code></pre>
</div>
<div id="accessing-the-data" class="section level3">
<h3>Accessing the data</h3>
<p>We can easily access data from the database via the helper function <code>sc::tbl</code> and subsequent dplyr (<a href="https://dplyr.tidyverse.org/" class="uri">https://dplyr.tidyverse.org/</a>) functions:</p>
<pre class="r"><code>sc::tbl(&quot;example_weather&quot;) %&gt;%
  dplyr::collect()
## # A tibble: 8 x 16
##   granularity_time granularity_geo location_code border age   sex    year  week
##   &lt;chr&gt;            &lt;chr&gt;           &lt;chr&gt;          &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt;
## 1 day              county          county03        2020 total total  2020    26
## 2 day              county          county03        2020 total total  2020    26
## 3 day              county          county03        2020 total total  2020    26
## 4 day              county          county03        2020 total total  2020    26
## 5 day              county          county03        2020 total total  2020    26
## 6 day              county          county03        2020 total total  2020    26
## 7 day              county          county03        2020 total total  2020    27
## 8 day              county          county03        2020 total total  2020    27
## # … with 8 more variables: yrwk &lt;chr&gt;, season &lt;chr&gt;, x &lt;dbl&gt;, date &lt;date&gt;,
## #   tg &lt;dbl&gt;, tx &lt;dbl&gt;, tn &lt;dbl&gt;, rr &lt;dbl&gt;</code></pre>
</div>
</div>
