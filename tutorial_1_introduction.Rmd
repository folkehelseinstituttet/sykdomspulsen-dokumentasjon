---
title: "Tutorial 1: Introduction"
description: |
  Which files go where, and what is in them?
date: 2021-07-15
author:
  - first_name: "Richard Aubrey"
    last_name: "White"
    url: https://www.fhi.no
    affiliation: Folkehelseinstituttet
    affiliation_url: https://www.fhi.no
    orcid_id: 0000-0002-6747-1726
output:
  distill::distill_article:
    toc: true
    toc_depth: 2
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE)
options(knitr.kable.NA = "")
library(scexample)
library(data.table)
library(magrittr)
library(sc)
```

## Setup

Implementing Sykdomspulsen Core requires a number of functions to be called in the correct order. To make this as simple as possible, we have provided a skeleton implementation at https://github.com/folkehelseinstituttet/scskeleton

You should clone this GitHub repo (https://github.com/folkehelseinstituttet/scskeleton) to your server. This will be the package that you will be working on throughout this tutorial. You may choose to do a global find/replace on `scskeleton` with the name you want for your R package. We will refer to this R package as your "sc implementation".

You should also clone https://github.com/folkehelseinstituttet/scexample to your server. This is the end product of the tutorial, and you should refer to it in order to check your work.

For the purposes of this tutorial, we assume that the reader is either using RStudio Server Open Source or RStudio Workbench inside Docker containers that have been built according to the Sykdomspulsen specifications. We will refer to your implementation of RStudio Server Open Source/RStudio Workbench with the generic term "RStudio".

## Load the code

Open `scskeleton` in [RStudio project mode](https://support.rstudio.com/hc/en-us/articles/200526207-Using-Projects). Restart the R session via `Ctrl+Shift+F10`, `rstudioapi::restartSession()`, or `Session > Restart R`. This will ensure that you have a clean working environment before you begin. You may now load your sc implementation. This can be done via `Ctrl+Shift+L`, `devtools::load_all(".")`, or `Build > Load All`.

<aside>
In general, we recommend cleaning your working environment every time before running `devtools::load_all(".")`.
</aside>

```{r eval=FALSE, include=TRUE}
rstudioapi::restartSession()
devtools::load_all(".")
```

You can now see which schemas have been loaded. These schemas were included in the skeleton. Note that schemas beginning with `config_*` are special schemas that are automatically generated by `sc`.

```{r, include=TRUE}
sc::tm_get_schema_names()
```

You can now see which tasks have been loaded. These tasks were included in the skeleton.

```{r, include=TRUE}
sc::tm_get_task_names()
```

## Running

You can now run these tasks. Note that we use `scskeleton::tm_run_task` instead of `sc::tm_run_task`. This is because we want to ensure that `scexample::.onLoad` has been called.

```{r eval=FALSE, include=TRUE}
scskeleton::tm_run_task("weather_download_and_import_rawdata")
scskeleton::tm_run_task("weather_clean_data")
scskeleton::tm_run_task("weather_export_weather_plots")
```

## Develop

The first step when developing any task is specifying the schemas that will be used.

```{r, echo=FALSE}
options(width = 150)
x <- fhiplot::as_github_code("https://raw.githubusercontent.com/folkehelseinstituttet/scskeleton/main/R/03_db_schemas.r")
print(x, lines = 18:64, include_url = TRUE)
```

Here we define the name of the schema to be `anon_example_weather_rawdata`.

```{r, echo=FALSE}
options(width = 150)
print(x, lines = 20:22, include_url = TRUE)
```

These are validators that check:

- Are the column names/field types in the schema definition in line with style guidelines?
- Are the values/field contents of the datasets that will be uploaded to the database correct? E.g. Does a date column actually contain dates?

```{r, echo=FALSE}
options(width = 150)
print(x, lines = 61:63, include_url = TRUE)
```

When using `validator_field_types = sc::validator_field_types_sykdomspulsen` we expect that the first 16 columns are always as follows (i.e. standardized structural data):

```{r, echo=FALSE}
options(width = 150)
print(x, lines = 25:43, include_url = TRUE)
```

The extra columns that contain data:

```{r, echo=FALSE}
options(width = 150)
print(x, lines = 45:47, include_url = TRUE)
```

The combination of these columns represents a unique row in the dataset.

```{r, echo=FALSE}
options(width = 150)
print(x, lines = 49:55, include_url = TRUE)
```

Censoring that is applied to the datasets.

```{r, echo=FALSE}
options(width = 150)
print(x, lines = 56:60, include_url = TRUE)
```


## Changelog {.appendix}

2021-07-15: Draft created.
